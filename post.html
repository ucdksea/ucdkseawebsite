<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>KSEA Admin Post</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .focus-ring:focus{outline:3px solid rgba(57,84,166,.45); outline-offset:2px}
</style>
</head>
<body class="bg-slate-900 text-white min-h-dvh">
  <main class="max-w-5xl mx-auto px-4 py-10">
    <h1 class="text-2xl font-bold mb-6">Admin — Post Console</h1>

    <!-- 업로드 & 폼 -->
    <section class="grid md:grid-cols-2 gap-6">
      <!-- 업로드/미리보기 -->
      <div class="rounded-2xl border border-white/15 bg-white/5 p-5">
        <h2 class="font-semibold mb-3">1) Upload image</h2>
        <input id="file" type="file" accept="image/*" class="block w-full text-sm mb-3">
        <button id="btnUpload" class="px-3 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 font-semibold">Upload</button>
        <p id="uploadStatus" class="text-sm text-white/70 mt-2"></p>
        <img id="preview" class="mt-4 max-h-64 hidden rounded-lg w-full object-cover" />

        <!-- POLAROID 전용 포스터 업로드 -->
        <div id="extraUploadPoster" class="hidden mt-6 border-t border-white/10 pt-4">
          <h3 class="font-semibold mb-2 text-sm">Poster image (EVENT_POLAROID)</h3>
          <input id="file2" type="file" accept="image/*" class="block w-full text-sm mb-2">
          <button id="btnUpload2" class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-500 text-sm">Upload Poster</button>
          <p id="uploadStatus2" class="text-sm text-white/70 mt-1"></p>
        </div>
      </div>

      <!-- 폼 -->
      <div class="rounded-2xl border border-white/15 bg-white/5 p-5">
        <h2 class="font-semibold mb-3">2) Fill fields & Publish</h2>

        <label class="block text-sm mb-1">Target</label>
        <select id="target" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-4 focus-ring">
          <option value="POPUP">Index — Popup (until deleted)</option>
          <option value="EVENT_UPCOMING">Events — Upcoming</option>
          <option value="EVENT_POLAROID">Events — Polaroid</option>
          <option value="GM">GM page — Cards</option>
          <option value="OFFICER">Officers — Board</option>
        </select>

        <!-- 타입별 추가 필드 -->
        <div id="rowLink" class="hidden">
          <label class="block text-sm mb-1">Link URL (Google Form / Instagram)</label>
          <input id="linkUrl" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-4 focus-ring" placeholder="https://..." />
        </div>

        <div id="rowPolaroid" class="hidden">
          <label class="block text-sm mb-1">Instagram URL (optional)</label>
          <input id="instagramUrl" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring" placeholder="https://instagram.com/..."/>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">Semester</label>
              <input id="semester" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring" placeholder="Spring"/>
            </div>
            <div>
              <label class="block text-sm mb-1">Year</label>
              <input id="year" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring" placeholder="2025"/>
            </div>
          </div>
        </div>

        <div id="rowOfficer" class="hidden">
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm mb-1">English name</label>
              <input id="enName" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring"/>
            </div>
            <div>
              <label class="block text-sm mb-1">Korean name</label>
              <input id="koName" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring"/>
            </div>
          </div>
          <label class="block text-sm mb-1">Role (e.g., President)</label>
          <input id="role" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring"/>
          <label class="block text-sm mb-1">LinkedIn URL (optional)</label>
          <input id="linkedin" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-4 focus-ring" placeholder="https://www.linkedin.com/in/..."/>
        </div>

        <!-- 공통 필드 -->
        <label class="block text-sm mb-1">Title</label>
        <input id="title" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring" placeholder="(Popup/Upcoming은 선택)"/>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Date (yyyy-mm-dd)</label>
            <input id="date" type="date" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring"/>
          </div>
        </div>

        <label class="block text-sm mb-1">설명 (Korean)</label>
        <textarea id="descKo" rows="3" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-3 focus-ring"></textarea>

        <label class="block text-sm mb-1">Description (English)</label>
        <textarea id="descEn" rows="3" class="w-full rounded-xl bg-white/10 px-3 py-2 mb-4 focus-ring"></textarea>

        <button id="btnPublish" class="px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 font-semibold disabled:opacity-60">Publish</button>
        <p id="publishMsg" class="text-sm text-white/70 mt-2"></p>
      </div>
    </section>

    <!-- 목록 & 삭제 -->
    <section class="mt-10 space-y-6">
      <h2 class="text-xl font-semibold">Current Posts</h2>

      <div>
        <h3 class="font-semibold mb-2">Index — Popup</h3>
        <div id="list_POPUP" class="grid md:grid-cols-3 gap-3"></div>
      </div>

      <div>
        <h3 class="font-semibold mb-2">Events — Polaroid</h3>
        <div id="list_EVENT_POLAROID" class="grid md:grid-cols-3 gap-3"></div>
      </div>

      <div>
        <h3 class="font-semibold mb-2">GM</h3>
        <div id="list_GM" class="grid md:grid-cols-3 gap-3"></div>
      </div>

      <div>
        <h3 class="font-semibold mb-2">Events — Upcoming</h3>
        <div id="list_EVENT_UPCOMING" class="grid md:grid-cols-3 gap-3"></div>
      </div>
    </section>
  </main>

<script>
const DEV = location.hostname === "127.0.0.1" || location.hostname === "localhost";
const API = DEV ? "http://localhost:3000" : "";
const $ = (id) => document.getElementById(id);

let mainImageUrl = "";
let posterImageUrl = "";

// 타입별 UI 토글
$("target").addEventListener("change", applyTypeUI);
function applyTypeUI(){
  const t = $("target").value;
  ["rowLink","rowPolaroid","rowOfficer"].forEach(id => $(id).classList.add("hidden"));
  $("extraUploadPoster").classList.add("hidden");

  if (t === "POPUP" || t === "EVENT_UPCOMING") $("rowLink").classList.remove("hidden");
  if (t === "EVENT_POLAROID") { $("rowPolaroid").classList.remove("hidden"); $("extraUploadPoster").classList.remove("hidden"); }
  if (t === "OFFICER") $("rowOfficer").classList.remove("hidden");
}
applyTypeUI();

// 메인 이미지 업로드
$("btnUpload").addEventListener("click", async () => {
  const f = $("file").files && $("file").files[0];
  if (!f) { $("uploadStatus").textContent = "Choose an image first."; return; }
  const fd = new FormData(); fd.append("file", f);

  $("uploadStatus").textContent = "Uploading...";
  try {
    const r = await fetch(`${API}/api/upload`, { method: "POST", body: fd, credentials: "include" });
    if (!r.ok) throw new Error(`Upload failed (${r.status})`);
    const { url } = await r.json();
    mainImageUrl = url;
    $("uploadStatus").textContent = "Uploaded ✓";
    $("preview").src = mainImageUrl; $("preview").classList.remove("hidden");
  } catch (e) {
    $("uploadStatus").textContent = (e && e.message) ? e.message : "Upload error";
  }
});

// POLAROID 포스터 업로드
$("btnUpload2").addEventListener("click", async () => {
  const f = $("file2").files && $("file2").files[0];
  if (!f) { $("uploadStatus2").textContent = "Choose a poster first."; return; }
  const fd = new FormData(); fd.append("file", f);

  $("uploadStatus2").textContent = "Uploading...";
  try {
    const r = await fetch(`${API}/api/upload`, { method: "POST", body: fd, credentials: "include" });
    if (!r.ok) throw new Error(`Upload failed (${r.status})`);
    const { url } = await r.json();
    posterImageUrl = url;
    $("uploadStatus2").textContent = "Uploaded ✓";
  } catch (e) {
    $("uploadStatus2").textContent = (e && e.message) ? e.message : "Upload error";
  }
});

// 게시
$("btnPublish").addEventListener("click", async () => {
  const type = $("target").value;
  const base = {
    type,
    title: $("title").value.trim() || undefined,
    date: $("date").value || undefined,
    descKo: $("descKo").value.trim() || undefined,
    descEn: $("descEn").value.trim() || undefined,
  };

  try {
    let payload = { ...base, imageUrl: mainImageUrl || undefined };

    if (type === "POPUP") {
      if (!payload.imageUrl) throw new Error("Upload poster image.");
      payload.linkUrl = $("linkUrl").value.trim();
      if (!payload.linkUrl) throw new Error("Link URL required.");
    }

    if (type === "GM") {
      if (!payload.imageUrl) throw new Error("Upload image.");
      if (!payload.title) throw new Error('Title required (e.g., "2025 Spring General Members").');
    }

    if (type === "EVENT_POLAROID") {
      if (!payload.imageUrl) throw new Error("Upload activity image.");
      if (!payload.title) throw new Error("Title required.");
      payload.posterUrl    = posterImageUrl || undefined;
      payload.instagramUrl = $("instagramUrl").value.trim() || undefined;
      payload.semester     = $("semester").value.trim() || undefined;
      payload.year         = $("year").value.trim() || undefined;
    }

    if (type === "EVENT_UPCOMING") {
      if (!payload.imageUrl) throw new Error("Upload poster.");
      payload.linkUrl = $("linkUrl").value.trim();
      if (!payload.linkUrl) throw new Error("Link URL required.");
    }

    if (type === "OFFICER") {
      if (!payload.imageUrl) throw new Error("Upload photo.");
      payload.enName   = $("enName").value.trim();
      payload.koName   = $("koName").value.trim();
      payload.role     = $("role").value.trim();
      payload.linkedin = $("linkedin").value.trim() || undefined;
      if (!payload.enName || !payload.koName || !payload.role) throw new Error("Name/Role required.");
    }

    $("publishMsg").textContent = "Publishing...";
    $("btnPublish").disabled = true;

    const res = await fetch(`${API}/api/admin/posts`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      let info = ""; try { const d = await res.json(); info = d && (d.error || d.message) } catch {}
      throw new Error(info || `Publish failed (${res.status})`);
    }

    $("publishMsg").textContent = "Published ✓";
    refreshAll();
  } catch (e) {
    $("publishMsg").textContent = (e && e.message) ? e.message : "Error";
  } finally {
    $("btnPublish").disabled = false;
  }
});

// 목록 렌더/삭제
async function fetchList(type){
  const r = await fetch(`${API}/api/admin/posts?type=${type}&active=1`, { credentials:"include" });
  const j = await r.json();
  return j.posts || [];
}
function card(p){
  return `
    <div class="rounded-xl bg-white/5 border border-white/10 p-3">
      <img src="${p.imageUrl}" class="w-full h-36 object-cover rounded-lg mb-2">
      <div class="text-sm font-semibold">${p.title || "(no title)"}</div>
      <div class="text-xs text-white/60">${p.date ? new Date(p.date).toLocaleDateString() : ""}</div>
      <div class="text-xs text-white/70 line-clamp-3">${p.descKo || ""}</div>
      <div class="mt-2">
        <button data-id="${p.id}" class="btn-del px-3 py-1 rounded-lg bg-red-600 hover:bg-red-500 text-sm">Delete</button>
      </div>
    </div>`;
}
async function refresh(type){
  const list = await fetchList(type);
  const el = document.getElementById(`list_${type}`);
  el.innerHTML = list.map(card).join("");
  el.querySelectorAll(".btn-del").forEach(btn => {
    btn.addEventListener("click", async () => {
      const id = btn.getAttribute("data-id");
      if (!confirm("Delete (deactivate) this post?")) return;
      const r = await fetch(`${API}/api/admin/posts/${id}`, { method:"DELETE", credentials:"include" });
      if (r.ok) refresh(type);
    });
  });
}
function refreshAll(){ ["POPUP","EVENT_POLAROID","GM","EVENT_UPCOMING"].forEach(refresh); }
refreshAll();
</script>
</body>
</html>
