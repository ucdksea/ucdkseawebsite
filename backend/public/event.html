<!-- /Users/stephanie/Desktop/ucdksea-website/event.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UC DAVIS KSEA</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Site CSS -->
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/event.css" />
    <link rel="stylesheet" href="./css/media.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500&display=swap" rel="stylesheet" />

    <!-- Favicon -->
    <link rel="icon" href="./images/kseaicon/kseawhiteicon.png" type="image/png" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>

  <body>
    <!-- Header -->
    <section class="subheader3">
      <nav>
        <a href="/"><img src="./images/kseaicon/ksealogo_white.png" alt="UC Davis KSEA logo" /></a>
        <i class="fa-solid fa-bars" id="menuIcon" onclick="openMenu()"></i>
        <div class="nav-links" id="navLinks">
          <i class="fa-solid fa-xmark" id="closeIcon" onclick="closeMenu()"></i>
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/#about">About UCD KSEA</a></li>
            <li><a href="/officer">Officers</a></li>
            <li><a href="/gm">General Members</a></li>
            <li><a href="/event">Events</a></li>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/join">Join KSEA</a></li>
          </ul>
        </div>
      </nav>
      <h1>Events</h1>
    </section>

    <!-- Upcoming Event (백엔드 연동 / 기본은 숨김) -->
    <section id="upcomingSection" class="upcoming_event" style="display:none">
      <h2 style="font-weight:bold;">Upcoming Event</h2>
      <div id="upcomingBox" class="upcoming_event_posters">
        <a href="#" target="_blank" rel="noopener">
          <img id="upcomingImg" src="" alt="upcoming_event_img" class="upcoming_event_img" />
        </a>
      </div>
      <p class="upcomingDesc mt-4"></p>
      <hr class="my-12 h-0.5 w-[85%] border-t-0 bg-neutral-200 mx-auto" />
    </section>

    <!-- Event Gallery (백엔드 연동) -->
    <div class="event">
      <h1>Event Gallery</h1>
      <div id="polaroidGrid" class="event-container"></div>
    </div>

    <!-- 이미지 팝업 (event.js에서 사용) -->
    <div id="imagePopup" class="full-img" style="display: none">
      <span
        class="close"
        onclick="closeImage()"
        style="position:absolute;top:10px;right:20px;font-size:30px;color:white;cursor:pointer;"
      >X</span>

      <div class="carousel">
        <span class="prev" onclick="changeSlide(-1)" style="cursor:pointer;font-size:40px;color:white;margin-right:10px;">&#10094;</span>

        <div class="popup-content-wrapper" style="display:flex;justify-content:center;align-items:center">
          <div style="aspect-ratio:4 / 3;width:auto;overflow:hidden;display:flex;justify-content:center;align-items:center;">
            <img class="popup-content" id="popupImage" style="width:100%;height:auto" />
          </div>
          <div class="popup-text" id="popupText" style="color:black;text-align:center;margin-top:10px"></div>
        </div>

        <span class="next" onclick="changeSlide(1)" style="cursor:pointer;font-size:40px;color:white;margin-left:10px;">&#10095;</span>
      </div>
    </div>

    <!-- (필수) 팝업 동작 함수들 포함된 파일 -->
    <script src="./js/event.js"></script>
    <!-- <script>
      (function () {
        // event.js의 expandImage를 감싸서 data-large를 /file2/로 보정
        const prev = window.expandImage;
        window.expandImage = function (el) {
          try {
            const imgEl = el.querySelector('img');
            const large0 = imgEl?.getAttribute('data-large') || '';
            if (large0) {
              const large2 = (typeof toFile2 === 'function') ? toFile2(large0) : encodeURI(large0);
              imgEl.setAttribute('data-large', large2);
            }
          } catch (e) { /* no-op */ }
          return prev ? prev(el) : null;
        };
      })();
    </script>
 -->
    <!-- Footer -->
    <section class="footer">
      <app-footer _ngcontent-xno-c271="" _nghost-xno-c31="">
        <footer _ngcontent-xno-c31="">
          <div _ngcontent-xno-c31="" class="wrap-footer-info">
            <div _ngcontent-xno-c31="" class="con-info">
              <img
                _ngcontent-xno-c31=""
                src="./images/kseaicon/ksealogo_white.png"
                alt="KSEA_logo"
              />
              <ul _ngcontent-xno-c31="">
                <li _ngcontent-xno-c31="" id="ngcontent1">
                  Korean-American Scientists and Engineers Association (KSEA)
                </li>
                <li _ngcontent-xno-c31="" id="ngcontent2">
                  KSEA Young Generation Group | University of California, Davis
                </li>
                <li _ngcontent-xno-c31="">
                  <span style="color: rgb(223, 223, 223)"
                    >Email: ucdksea@gmail.com</span
                  >
                </li>
                <li _ngcontent-xno-c31="">
                  <span style="color: rgb(223, 223, 223)"
                    >Copyright © 2024 KSEA Sacramento chapter, All Rights
                    Reserved</span
                  >
                </li>
                <li>
                  <a href="/login"
                     rel="nofollow"
                     class="text-sm text-gray-400 hover:text-white hover:underline transition"
                     aria-label="Officer login (KSEA UC Davis officers only)">
                    Officer Login
                  </a>              
                </li>
              </ul>
            </div>
            <div><p><span style = "color: #3954A6 ;line-height: 0;">by 백지원&박여진</span></p></div>
            <div _ngcontent-xno-c31="" class="con-sns">
              <ul _ngcontent-xno-c31="">
                <li _ngcontent-xno-c31="">
                  <a
                    _ngcontent-xno-c31=""
                    href="https://www.instagram.com/kseadavis/"
                    target="_blank"
                    ><img
                      _ngcontent-xno-c31=""
                      src="./images/instagram.png"
                      width="50"
                      height="50"
                      alt="KSEA instagram"
                  /></a>
                </li>
                <li _ngcontent-xno-c31="">
                  <a
                    _ngcontent-xno-c31=""
                    href="https://linktr.ee/ucdksea"
                    target="_blank"
                    ><img
                      _ngcontent-xno-c31=""
                      src="./images/linktree.png"
                      width="50"
                      height="50"
                      alt="Ksea linktree"
                  /></a>
                </li>
              </ul>
            </div>
          </div>
        </footer>
      </app-footer>
    </section>

    <!-- 모바일 메뉴 토글 -->
    <script>
      const navLinks = document.getElementById("navLinks");
      const menuIcon = document.getElementById("menuIcon");
      const closeIcon = document.getElementById("closeIcon");

      function openMenu() {
        navLinks.style.right = "0";
        menuIcon.style.display = "none";
        closeIcon.style.display = "block";
      }

      function closeMenu() {
        navLinks.style.right = "-200px";
        menuIcon.style.display = "block";
        closeIcon.style.display = "none";
      }
    </script>

    <!-- 백엔드 연동 스크립트 (데이터 없으면 안 보이게/조용히 실패) -->
    <script>
      // 로컬 개발 환경 감지 강화: localhost, 127.0.0.1, 0.0.0.0, 192.168.x.x, 포트 5500
      const isLocalHost =
        /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/.test(location.hostname) ||
        /^192\.168\./.test(location.hostname) ||
        location.port === "5500";
    
      const DEV = isLocalHost;
      const API_BASE = "https://api.ucdksea.com";  // 절대경로!
      const API = API_BASE;  
      fetch(`${API_BASE}/api/ping`, { credentials: "include" });
          </script>
          <script>
            // 안전한 절대 URL 만들기(인코딩만, 리라이트 없음)
            function absUrl(u){
              if(!u) return "";
              try{
                const base = (typeof API !== "undefined" && API) ? API : location.origin;
                const url  = u.startsWith("http") ? new URL(u) : new URL(u, base);
                return encodeURI(url.toString());
              }catch{
                return encodeURI(u);
              }
            }
          
            // 같은 호스트(= API)일 때만 /file → /file2 리라이트
            function toPublicImage(u){
              if (!u) return "";
              try {
                const base = (typeof API !== "undefined" && API) ? API : location.origin;
                const api  = new URL(base);
                const url  = u.startsWith("http") ? new URL(u) : new URL(u, base);
          
                if (url.host !== api.host) return url.toString();
          
                let p = url.pathname;
                if (p.startsWith("/file2/")) return url.toString();
                if (p.startsWith("/file/"))         p = p.replace("/file/", "/file2/");
                else if (p.startsWith("/uploads/")) p = "/file2" + p;
                else if (p.includes("/uploads/"))   p = p.replace("/uploads/", "/file2/uploads/");
                url.pathname = p;
                return encodeURI(url.toString());
              } catch {
                return u;
              }
            }
          
            // ---- 로더 (절대 → 원본 → 프록시 순) ----
            (function attachPolaroidLoader(){
              const grid = document.getElementById('polaroidGrid');
              if(!grid) return;
          
              grid.querySelectorAll('.polaroid img').forEach(img => {
                const src0 = img.getAttribute('data-src-original') || "";
                if (!src0) return;
          
                const first  = absUrl(src0);         // 1) 절대 URL(가장 안전)
                const second = src0;                 // 2) 원본 그대로
                const third  = toPublicImage(src0);  // 3) /file2 리라이트(프록시)
          
                const tried = new Set();
                const cands = [first, second, third].filter(u => u && !tried.has(u) && (tried.add(u), true));
          
                let i = 0;
                function tryNext() {
                  if (i >= cands.length) { img.alt = "(image not available)"; return; }
                  img.src = cands[i++];
                }
                img.onerror = tryNext;
                // CORS 이슈 최소화(쿠키 불필요 이미지 로드)
                img.setAttribute('crossorigin', 'anonymous');
                img.referrerPolicy = 'no-referrer';
          
                tryNext();
          
                // 팝업용 large 기본값
                img.setAttribute('data-large', cands[0] || src0);
              });
            })();
          </script>          
          
          <script>
            // 같은 호스트(= API)일 때만 공개 프록시(/file2/…)로 안전 리라이트
            function toPublicImage(u){
              if (!u) return "";
              try {
                const base = (typeof API !== "undefined" && API) ? API : location.origin;
                const api  = new URL(base);
                const url  = u.startsWith("http") ? new URL(u) : new URL(u, base);
          
                // 외부 호스트는 손대지 않음
                if (url.host !== api.host) return url.toString();
          
                let p = url.pathname;
                if (p.startsWith("/file2/")) return url.toString();
                if (p.startsWith("/file/"))      p = p.replace("/file/", "/file2/");
                else if (p.startsWith("/uploads/")) p = "/file2" + p;
                else if (p.includes("/uploads/"))   p = p.replace("/uploads/", "/file2/uploads/");
                url.pathname = p;
          
                // 경로에 공백/한글 있을 수 있으니 전체를 1회만 인코딩
                return encodeURI(url.toString());
              } catch {
                return u;
              }
            }
          </script>
          
            
          
    

    <!-- 1) Event Polaroid (Gallery) -->
    <script>
      // ---------- 공용 유틸 ----------
      function absUrl(u){
        if(!u) return "";
        try{
          const base = (typeof API !== "undefined" && API) ? API : location.origin;
          const url  = u.startsWith("http") ? new URL(u) : new URL(u, base);
          return encodeURI(url.toString());
        }catch{ return encodeURI(u); }
      }
    
      // 같은 호스트(= API)일 때만 /file → /file2 리라이트
      function toPublicImage(u){
        if (!u) return "";
        try {
          const base = (typeof API !== "undefined" && API) ? API : location.origin;
          const api  = new URL(base);
          const url  = u.startsWith("http") ? new URL(u) : new URL(u, base);
          if (url.host !== api.host) return url.toString();
    
          let p = url.pathname;
          if (p.startsWith("/file2/")) return url.toString();
          if (p.startsWith("/file/"))         p = p.replace("/file/", "/file2/");
          else if (p.startsWith("/uploads/")) p = "/file2" + p;
          else if (p.includes("/uploads/"))   p = p.replace("/uploads/", "/file2/uploads/");
          url.pathname = p;
          return encodeURI(url.toString());
        } catch { return u; }
      }
    
      // (응급용) 공개 이미지 프록시 — 백엔드 /file2가 아직 열리지 않았다면 마지막 후보로만 사용
      function wsrv(u){
        try{
          const abs = absUrl(u);
          const clean = abs.replace(/^https?:\/\//,'');  // images.weserv.nl 규격
          return `https://images.weserv.nl/?url=${encodeURIComponent(clean)}`;
        }catch{ return ""; }
      }
    
      function uniq(list){
        const s = new Set(); const out = [];
        for (const x of list) if (x && !s.has(x)) { s.add(x); out.push(x); }
        return out;
      }
    
      // ---------- 갤러리 렌더 + 로더 ----------
      (async () => {
        const wrap = document.getElementById("polaroidGrid");
        if (!wrap) return;
    
        const esc = (s)=> (s||"").toString().replace(/"/g,"&quot;");
    
        try {
          const r = await fetch(`${API}/api/admin/posts?type=EVENT_POLAROID&active=1`, { credentials: "omit" });
          if (!r.ok) throw new Error(r.status);
          const { posts = [] } = await r.json();
          if (!posts.length) { wrap.innerHTML = ""; return; }
    
          const html = posts.map((p) => {
            const m = p.meta || {};
            const src0 =
              p.imageUrl || m.imageUrl ||
              p.posterUrl || m.posterUrl ||
              (Array.isArray(p.images) && p.images[0]) ||
              (Array.isArray(m.images) && m.images[0]) || "";
    
            const title   = (p.title || "").trim();
            const quarter = (p.quarter || m.quarter || p.semester || m.semester || "").trim();
            const year    = (p.year || m.year || "").trim();
            const captionRaw = (quarter && year) ? `${quarter} ${year}` : title;
            const dateStr    = p.date ? new Date(p.date).toISOString().slice(0,10) : "";
            const bottomCaption = [captionRaw, title].filter(Boolean).join(" ");
            const primaryLink = (p.instagramUrl || p.formUrl || p.linkUrl || m.instagramUrl || m.formUrl || "").trim();
    
            const line1 = `${esc(title)}$<span style='color:gray;'>${esc(captionRaw)}${dateStr ? " | " + dateStr : ""}</span>$<span style='color:#ececec;'>_____________________</span>$`;
            const line2 = p.descKo ? `<br>${esc(p.descKo)}$` : "";
            const line3 = p.descEn ? `<br>${esc(p.descEn)}<br>$` : "";
            const dataTextEnc = encodeURIComponent([line1, line2, line3, "<img-poster/>"].join(""));
    
            return `
              <div class="event-item">
                <div class="polaroid" onclick="expandImage(this)">
                  <img
                    alt="${esc(title)}"
                    src=""
                    data-src-original="${esc(src0)}"
                    data-text-enc="${esc(dataTextEnc)}"
                    data-link="${esc(primaryLink)}"
                    referrerpolicy="no-referrer"
                  />
                  <p>${esc(bottomCaption)}</p>
                  ${primaryLink ? `<div style="margin-top:6px;">
                    <a href="${esc(primaryLink)}" target="_blank" rel="noopener noreferrer" class="text-sm underline">More details</a>
                  </div>` : ""}
                </div>
              </div>
            `;
          }).join("");
    
          wrap.innerHTML = html;
    
          // ✅ 여기서 '한 번만' 로더 바인딩 (공개 후보 → 원본 → /file2 → wsrv)
          wrap.querySelectorAll('.polaroid img').forEach(img => {
            const src0 = img.getAttribute('data-src-original') || "";
            if (!src0) return;
    
            const cands = uniq([
              // 공개로 열릴 확률 높은 순
              absUrl(src0),           // https://api.ucdksea.com/... (쿠키 없이 접근 시 401일 수도 있음)
              src0,                   // 데이터 그대로
              toPublicImage(src0),    // /file2 리라이트 (배포되어 있으면 OK)
              wsrv(src0),             // 응급용 공개 프록시
            ]);
    
            let i = 0;
            function tryNext() {
              if (i >= cands.length) { img.alt = "(image not available)"; return; }
              img.src = cands[i++];
            }
            img.onerror = tryNext;
            img.setAttribute('crossorigin','anonymous');
            img.referrerPolicy = 'no-referrer';
            img.setAttribute('data-large', cands[0] || src0);
            tryNext();
          });
    
        } catch(e) {
          console.warn("EVENT_POLAROID fetch failed:", e);
          wrap.innerHTML = "";
        }
      })();
    </script>
    
      
     
      

<!-- 2) Upcoming Event (있을 때만 표시) -->
<script>
  (async () => {
    const section = document.getElementById("upcomingSection");
    const box = document.getElementById("upcomingBox");
    const a = box ? box.querySelector("a") : null;
    const img = document.getElementById("upcomingImg");
    const descEl = document.querySelector(".upcomingDesc");
    if (!section || !box || !a || !img || !descEl) return;

    try {
      const r = await fetch(`${API}/api/admin/posts?type=EVENT_UPCOMING&active=1`, { credentials: "omit" });
      if (!r.ok) throw new Error(r.status);
      const { posts = [] } = await r.json();

      if (!posts.length) { section.style.display = "none"; return; }

      const p = posts[0];
      section.style.display = "";

      const href = p.meta?.formUrl || p.meta?.instagramUrl || p.linkUrl || "#";
      a.href = href;
      if (href === "#") a.addEventListener("click", (e) => e.preventDefault());

      const original = p.meta?.posterUrl || p.imageUrl || "";
      const cands = uniq([ absUrl(original), original, toPublicImage(original), wsrv(original) ]);

      let i = 0;
      function tryNext(){ if(i >= cands.length){ img.alt = "(image not available)"; return; } img.src = cands[i++]; }
      img.onerror = tryNext;
      img.setAttribute('crossorigin','anonymous');
      img.referrerPolicy = 'no-referrer';
      tryNext();

      descEl.innerHTML = p.descKo || p.descEn || "";
    } catch (e) {
      console.warn("EVENT_UPCOMING fetch failed:", e);
      section.style.display = "none";
    }
  })();
</script>


  </body>
</html>
