<!-- /Users/stephanie/Desktop/ucdksea-website/event.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UC DAVIS KSEA</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Site CSS -->
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/event.css" />
    <link rel="stylesheet" href="./css/media.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500&display=swap" rel="stylesheet" />

    <!-- Favicon -->
    <link rel="icon" href="./images/kseaicon/kseawhiteicon.png" type="image/png" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>

  <body>
    <!-- Header -->
    <section class="subheader3">
      <nav>
        <a href="/"><img src="./images/kseaicon/ksealogo_white.png" alt="UC Davis KSEA logo" /></a>
        <i class="fa-solid fa-bars" id="menuIcon" onclick="openMenu()"></i>
        <div class="nav-links" id="navLinks">
          <i class="fa-solid fa-xmark" id="closeIcon" onclick="closeMenu()"></i>
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/#about">About UCD KSEA</a></li>
            <li><a href="/officer">Officers</a></li>
            <li><a href="/gm">General Members</a></li>
            <li><a href="/event">Events</a></li>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/join">Join KSEA</a></li>
            <li><a href="https://api.ucdksea.com/log" class="text-blue-400 transition">Log</a></li>
          </ul>
        </div>
      </nav>
      <h1>Events</h1>
    </section>

    <!-- Upcoming Event (백엔드 연동 / 기본은 숨김) -->
    <section id="upcomingSection" class="upcoming_event" style="display:none">
      <h2 style="font-weight:bold;">Upcoming Event</h2>
      <div id="upcomingBox" class="upcoming_event_posters">
        <a href="#" target="_blank" rel="noopener">
          <img id="upcomingImg" src="" alt="upcoming_event_img" class="upcoming_event_img" />
        </a>
      </div>
      <p class="upcomingDesc mt-4"></p>
      <hr class="my-12 h-0.5 w-[85%] border-t-0 bg-neutral-200 mx-auto" />
    </section>

    <!-- Event Gallery (백엔드 연동) -->
    <div class="event">
      <h1>Event Gallery</h1>
      <div id="polaroidGrid" class="event-container"></div>
    </div>

    <!-- 이미지 팝업 (event.js에서 사용) -->
    <div id="imagePopup" class="full-img" style="display: none">
      <span
        class="close"
        onclick="closeImage()"
        style="position:absolute;top:10px;right:20px;font-size:30px;color:white;cursor:pointer;"
      >X</span>

      <div class="carousel">
        <span class="prev" onclick="changeSlide(-1)" style="cursor:pointer;font-size:40px;color:white;margin-right:10px;">&#10094;</span>

        <div class="popup-content-wrapper" style="display:flex;justify-content:center;align-items:center">
          <div style="aspect-ratio:4 / 3;width:auto;overflow:hidden;display:flex;justify-content:center;align-items:center;">
            <img class="popup-content" id="popupImage" style="width:100%;height:auto" />
          </div>
          <div class="popup-text" id="popupText" style="color:black;text-align:center;margin-top:10px"></div>
        </div>

        <span class="next" onclick="changeSlide(1)" style="cursor:pointer;font-size:40px;color:white;margin-left:10px;">&#10095;</span>
      </div>
    </div>

    <!-- (필수) 팝업 동작 함수들 포함된 파일 -->
    <script src="./js/event.js"></script>

    <script>
      (function () {
        const PROD = "https://api.ucdksea.com";
        if (!("API_BASE" in window)) window.API_BASE = PROD;
        if (!("API" in window))      window.API     = window.API_BASE;
        fetch(`${window.API_BASE}/api/ping`, { credentials: "include" }).catch(()=>{});
      })();
    </script>
    
    <script>
      // expandImage가 팝업을 띄운 다음, 본문(#popupText) 끝에 포스터 <a><img>를 삽입
      (function () {
        const prev = window.expandImage;
        window.expandImage = function (el) {
          const ret = prev ? prev(el) : null;
          try {
            const imgEl = el.querySelector('img');
            const posterRaw = imgEl?.getAttribute('data-poster') || '';
            const linkHref  = imgEl?.getAttribute('data-link') || '';
            const posterUrl = posterRaw ? bestPublicUrl(posterRaw) : '';
      
            const box = document.getElementById('popupText');
            if (box && posterUrl) {
              const a = document.createElement('a');
              a.href = linkHref || '#';
              if (linkHref) { a.target = '_blank'; a.rel = 'noopener'; }
      
              const pic = document.createElement('img');
              pic.src = posterUrl;
              pic.alt = 'event poster';
              pic.style.maxWidth = '100%';
              pic.style.height = 'auto';
              pic.style.marginTop = '12px';
      
              a.appendChild(pic);
              // 기존 텍스트 아래에 포스터 추가
              box.appendChild(a);
            }
          } catch (_) {}
          return ret;
        };
      })();
      </script>
          <!-- Footer -->
    <section class="footer">
      <app-footer _ngcontent-xno-c271="" _nghost-xno-c31="">
        <footer _ngcontent-xno-c31="">
          <div _ngcontent-xno-c31="" class="wrap-footer-info">
            <div _ngcontent-xno-c31="" class="con-info">
              <img
                _ngcontent-xno-c31=""
                src="./images/kseaicon/ksealogo_white.png"
                alt="KSEA_logo"
              />
              <ul _ngcontent-xno-c31="">
                <li _ngcontent-xno-c31="" id="ngcontent1">
                  Korean-American Scientists and Engineers Association (KSEA)
                </li>
                <li _ngcontent-xno-c31="" id="ngcontent2">
                  KSEA Young Generation Group | University of California, Davis
                </li>
                <li _ngcontent-xno-c31="">
                  <span style="color: rgb(223, 223, 223)"
                    >Email: ucdksea@gmail.com</span
                  >
                </li>
                <li _ngcontent-xno-c31="">
                  <span style="color: rgb(223, 223, 223)"
                    >Copyright © 2024 KSEA Sacramento chapter, All Rights
                    Reserved</span
                  >
                </li>
                <li>
                  <a href="/login"
                     rel="nofollow"
                     class="text-sm text-gray-400 hover:text-white hover:underline transition"
                     aria-label="Officer login (KSEA UC Davis officers only)">
                    Officer Login
                  </a>              
                </li>
              </ul>
            </div>
            <div><p><span style = "color: #3954A6 ;line-height: 0;">by 백지원&박여진</span></p></div>
            <div _ngcontent-xno-c31="" class="con-sns">
              <ul _ngcontent-xno-c31="">
                <li _ngcontent-xno-c31="">
                  <a
                    _ngcontent-xno-c31=""
                    href="https://www.instagram.com/kseadavis/"
                    target="_blank"
                    ><img
                      _ngcontent-xno-c31=""
                      src="./images/instagram.png"
                      width="50"
                      height="50"
                      alt="KSEA instagram"
                  /></a>
                </li>
                <li _ngcontent-xno-c31="">
                  <a
                    _ngcontent-xno-c31=""
                    href="https://linktr.ee/ucdksea"
                    target="_blank"
                    ><img
                      _ngcontent-xno-c31=""
                      src="./images/linktree.png"
                      width="50"
                      height="50"
                      alt="Ksea linktree"
                  /></a>
                </li>
              </ul>
            </div>
          </div>
        </footer>
      </app-footer>
    </section>

    <!-- 모바일 메뉴 토글 -->
    <script>
      const navLinks = document.getElementById("navLinks");
      const menuIcon = document.getElementById("menuIcon");
      const closeIcon = document.getElementById("closeIcon");

      function openMenu() {
        navLinks.style.right = "0";
        menuIcon.style.display = "none";
        closeIcon.style.display = "block";
      }

      function closeMenu() {
        navLinks.style.right = "-200px";
        menuIcon.style.display = "block";
        closeIcon.style.display = "none";
      }
    </script>
          <script>
            // 같은 호스트(= API)일 때만 공개 프록시(/file2/…)로 시도
            function toPublicImage(u){
              if (!u) return "";
              try {
                const base = (typeof API !== "undefined" && API) ? API : location.origin;
                const api  = new URL(base);
                const url  = u.startsWith("http") ? new URL(u) : new URL(u, base);
                if (url.host !== api.host) return url.toString(); // 외부 호스트는 건드리지 않음
                let p = url.pathname;
                if (p.startsWith("/file2/")) return url.toString();
                if (p.startsWith("/file/"))       p = p.replace("/file/", "/file2/");
                else if (p.startsWith("/uploads/")) p = "/file2" + p;
                else if (p.includes("/uploads/"))  p = p.replace("/uploads/", "/file2/uploads/");
                url.pathname = p;
                return encodeURI(url.toString());
              } catch { return u; }
            }
          
            // 같은 호스트 + 비공개 경로(/uploads|/file)면, 쿠키 포함 fetch → blob URL로 세팅
            async function loadImageWithAuth(imgEl, rawUrl){
              if (!rawUrl) return;
              const base = (typeof API !== "undefined" && API) ? API : location.origin;
              let url;
              try { url = rawUrl.startsWith("http") ? new URL(rawUrl) : new URL(rawUrl, base); }
              catch { url = new URL(String(rawUrl), base); }
          
              const isSameHost = url.host === new URL(base).host;
              const path = url.pathname || "";
              const looksPrivate = /^\/(uploads|file)\b/.test(path);
          
              // 1) 인증 fetch → blob
              if (isSameHost && looksPrivate) {
                try {
                  const r = await fetch(url.toString(), { credentials: "include" });
                  if (!r.ok) throw new Error("HTTP "+r.status);
                  const blob = await r.blob();
                  const objUrl = URL.createObjectURL(blob);
                  imgEl.src = objUrl;
                  imgEl.dataset.objUrl = objUrl; // 필요하면 나중에 revoke 가능
                  return;
                } catch (_) {
                  /* 실패 시 2) 프록시로 폴백 */
                }
              }
          
              // 2) 공개 프록시(/file2) 시도
              const viaProxy = toPublicImage(url.toString());
              imgEl.src = viaProxy;
          
              // 3) 마지막 폴백: 원본 그대로
              imgEl.onerror = function(){
                if (imgEl.dataset.falled === "1") return;
                imgEl.dataset.falled = "1";
                imgEl.src = url.toString();
              };
            }
          </script>
          <script>
            // ===== URL helpers (최종) =====
            // 모든 후보 URL은 오직 API_BASE 호스트만 사용 (CORS 회피)
            function _dedupe(arr){ return [...new Set(arr.filter(Boolean))]; }
          
            function ensureUploadsPath(raw){
              if (!raw) return "";
              if (/^https?:\/\//i.test(raw)) return raw;               // 이미 절대 URL이면 그대로
              if (raw.startsWith("/uploads/")) return raw;              // /uploads/... 면 그대로
              // 맨 파일명만 온 경우 자동 보정
              if (/^\d{10,}_.+\.(jpe?g|png|gif|webp)$/i.test(raw)) return "/uploads/posts/" + raw;
              return raw;
            }
          
            function _absUrlOnAPI(pathOrUrl){
              const base = (typeof API !== "undefined" && API) ? API : (window.API_BASE || "https://api.ucdksea.com");
              // 이미 절대 URL이어도 호스트를 API로 강제 스왑
              try {
                const u = pathOrUrl.startsWith("http") ? new URL(pathOrUrl) : new URL(pathOrUrl, base);
                const api = new URL(base);
                u.protocol = api.protocol;
                u.host     = api.host;
                return u;
              } catch {
                return new URL(String(pathOrUrl || "/"), base);
              }
            }
          
            // 후보 URL 생성기: 오직 API 호스트에서만 /uploads, /file2 변형을 시도
            function buildImageCandidates(raw){
              const fixed = ensureUploadsPath(raw);
              const u0    = _absUrlOnAPI(fixed);
              const p     = u0.pathname || "";
              const c     = [];
          
              // 1) 원본 on API
              c.push(u0.toString());
          
              // 2) /file2, /file 변형
              if (p.startsWith("/file2/")) {
                c.push(u0.toString());
              } else if (p.startsWith("/file/")) {
                const v2 = new URL(u0.toString()); v2.pathname = p.replace("/file/","/file2/"); c.push(v2.toString());
                c.push(u0.toString());
              } else if (p.startsWith("/uploads/")) {
                const v2 = new URL(u0.toString()); v2.pathname = "/file2" + p; c.push(v2.toString());
                const v1 = new URL(u0.toString()); v1.pathname = "/file"  + p; c.push(v1.toString());
              } else {
                // 맨 파일명 등 비업로드 경로 => /uploads/posts 로 보정하여 3종 시도
                const fname = p.replace(/^\/+/,"");
                if (/^\d{10,}_.+\.(jpe?g|png|gif|webp)$/i.test(fname)) {
                  const v2 = new URL(u0.toString()); v2.pathname = "/file2/uploads/posts/" + fname; c.push(v2.toString());
                  const v1 = new URL(u0.toString()); v1.pathname = "/file/uploads/posts/"  + fname; c.push(v1.toString());
                  const v0 = new URL(u0.toString()); v0.pathname = "/uploads/posts/"       + fname; c.push(v0.toString());
                }
              }
              return _dedupe(c).map(s => encodeURI(s));
            }
          
            // 공개 이미지 로더: API 호스트들만 돌면서 첫 성공 blob로 보여줌 (CORS OK)
            async function loadImageSmart(imgEl, raw){
              const cands = buildImageCandidates(raw);
              for (const href of cands){
                try{
                  const r = await fetch(href, { credentials: "omit" });  // API는 이미지에 CORS 헤더 있음
                  if (!r.ok) continue;
                  const ct = r.headers.get("content-type") || "";
                  if (!ct.startsWith("image/")) continue;
                  const blob = await r.blob();
                  if (imgEl.dataset.objUrl) URL.revokeObjectURL(imgEl.dataset.objUrl);
                  const objUrl = URL.createObjectURL(blob);
                  imgEl.src = objUrl;
                  imgEl.dataset.objUrl = objUrl;
                  return;
                }catch{/* try next */}
              }
              imgEl.src = cands[0] || "";
            }
          
            function bestPublicUrl(raw){
              const cands = buildImageCandidates(raw);
              return cands[0] || "";
            }
          </script>
          
                
    <!-- 1) Event Polaroid (Gallery) -->
    <script>
      (async () => {
        const wrap = document.getElementById("polaroidGrid");
        if (!wrap) return;
      
        const esc = (s)=> (s||"").toString().replace(/"/g,"&quot;");
      
        try {
          const r = await fetch(`${API}/api/admin/posts?type=EVENT_POLAROID&active=1`, { credentials: "omit" });
          if (!r.ok) throw new Error(r.status);
          const { posts = [] } = await r.json();
          if (!posts.length) { wrap.innerHTML = ""; return; }
      
          const html = posts.map((p) => {
            const m = p.meta || {};
            const src0 =
              p.imageUrl || m.imageUrl ||
              p.posterUrl || m.posterUrl ||
              (Array.isArray(p.images) && p.images[0]) ||
              (Array.isArray(m.images) && m.images[0]) || "";
            
            const poster0 = m.posterUrl || p.posterUrl || src0;  
            const title   = (p.title || "").trim();
            const quarter = (p.quarter || m.quarter || p.semester || m.semester || "").trim();
            const year    = (p.year || m.year || "").trim();
            const captionRaw = (quarter && year) ? `${quarter} ${year}` : title;
            const dateStr    = p.date ? new Date(p.date).toISOString().slice(0,10) : "";
            const bottomCaption = [captionRaw, title].filter(Boolean).join(" ");
            const primaryLink = (p.instagramUrl || p.formUrl || p.linkUrl || m.instagramUrl || m.formUrl || "").trim();
      
            const line1 = `${esc(title)}$<span style='color:gray;'>${esc(captionRaw)}${dateStr ? " | " + dateStr : ""}</span>$<span style='color:#ececec;'>_____________________</span>$`;
            const line2 = p.descKo ? `<br>${esc(p.descKo)}$` : "";
            const line3 = p.descEn ? `<br>${esc(p.descEn)}<br>$` : "";
            const dataTextEnc = encodeURIComponent([line1, line2, line3, "<img-poster/>"].join(""));
      
            return `
              <div class="event-item">
                <div class="polaroid" onclick="expandImage(this)">
                  <img
                    alt="${esc(title)}"
                    data-src="${esc(src0)}"        
                    data-large="${esc(src0)}"
                    data-text-enc="${esc(dataTextEnc)}"
                    data-link="${esc(primaryLink)}"
                    data-poster="${esc(poster0)}" 
                  />
                  <p>${esc(bottomCaption)}</p>
                  ${primaryLink ? `<div style="margin-top:6px;">
                    <a href="${esc(primaryLink)}" target="_blank" rel="noopener" class="text-sm underline"></a>
                  </div>` : ""}
                </div>
              </div>
            `;
          }).join("");
      
          wrap.innerHTML = html;
      
          // ✅ 여기서 실제 로딩 수행 (인증 fetch → /file2 → 원본 순으로)
          const imgs = wrap.querySelectorAll('.polaroid img[data-src]');
          imgs.forEach(img => {
            const raw = img.getAttribute('data-src') || "";
            const largeRaw = img.getAttribute('data-large') || "";
            loadImageSmart(img, raw);
            img.setAttribute('data-large', bestPublicUrl(largeRaw || raw));
          });

        } catch (e) {
          console.warn("EVENT_POLAROID fetch failed:", e);
          wrap.innerHTML = "";
        }
      })();

      </script>

      <script>
        (async () => {
          const section = document.getElementById("upcomingSection");
          const box = document.getElementById("upcomingBox");
          const a = box ? box.querySelector("a") : null;
          const img = document.getElementById("upcomingImg");
          const descEl = document.querySelector(".upcomingDesc");
          if (!section || !box || !a || !img || !descEl) return;
        
          try {
            const r = await fetch(`${API}/api/admin/posts?type=EVENT_UPCOMING&active=1`, { credentials: "omit" });
            if (!r.ok) throw new Error(r.status);
            const { posts = [] } = await r.json();
        
            if (!posts.length) { section.style.display = "none"; return; }
        
            const p = posts[0];
            section.style.display = "";
        
            const href = p.meta?.formUrl || p.meta?.instagramUrl || p.linkUrl || "#";
            a.href = href;
            if (href === "#") a.addEventListener("click", (e) => e.preventDefault());
        
            const original = p.meta?.posterUrl || p.imageUrl || "";
            await loadImageSmart(img, original);   // ✅ 위 스마트 로더 사용
            descEl.innerHTML = p.descKo || p.descEn || "";
          } catch (e) {
            console.warn("EVENT_UPCOMING fetch failed:", e);
            section.style.display = "none";
          }
        })();
        </script>
        
  
  

  </body>
</html>
