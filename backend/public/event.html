<!-- /Users/stephanie/Desktop/ucdksea-website/event.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UC DAVIS KSEA</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Site CSS -->
    <link rel="stylesheet" href="./css/style.css" />
    <link rel="stylesheet" href="./css/event.css" />
    <link rel="stylesheet" href="./css/media.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500&display=swap" rel="stylesheet" />

    <!-- Favicon -->
    <link rel="icon" href="./images/kseaicon/kseawhiteicon.png" type="image/png" />

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  </head>

  <body>
    <!-- Header -->
    <section class="subheader3">
      <nav>
        <a href="/"><img src="./images/kseaicon/ksealogo_white.png" alt="UC Davis KSEA logo" /></a>
        <i class="fa-solid fa-bars" id="menuIcon" onclick="openMenu()"></i>
        <div class="nav-links" id="navLinks">
          <i class="fa-solid fa-xmark" id="closeIcon" onclick="closeMenu()"></i>
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/#about">About UCD KSEA</a></li>
            <li><a href="/officer">Officers</a></li>
            <li><a href="/gm">General Members</a></li>
            <li><a href="/event">Events</a></li>
            <li><a href="/faq">FAQ</a></li>
            <li><a href="/join">Join KSEA</a></li>
          </ul>
        </div>
      </nav>
      <h1>Events</h1>
    </section>

    <!-- Upcoming Event (ë°±ì—”ë“œ ì—°ë™ / ê¸°ë³¸ì€ ìˆ¨ê¹€) -->
    <section id="upcomingSection" class="upcoming_event" style="display:none">
      <h2 style="font-weight:bold;">Upcoming Event</h2>
      <div id="upcomingBox" class="upcoming_event_posters">
        <a href="#" target="_blank" rel="noopener">
          <img id="upcomingImg" src="" alt="upcoming_event_img" class="upcomig_event_img" />
        </a>
      </div>
      <p class="upcomingDesc mt-4"></p>
      <hr class="my-12 h-0.5 w-[85%] border-t-0 bg-neutral-200 mx-auto" />
    </section>

    <!-- Event Gallery (ë°±ì—”ë“œ ì—°ë™) -->
    <div class="event">
      <h1>Event Gallery</h1>
      <div id="polaroidGrid" class="event-container"></div>
    </div>

    <!-- ì´ë¯¸ì§€ íŒì—… (event.jsì—ì„œ ì‚¬ìš©) -->
    <div id="imagePopup" class="full-img" style="display: none">
      <span
        class="close"
        onclick="closeImage()"
        style="position:absolute;top:10px;right:20px;font-size:30px;color:white;cursor:pointer;"
      >X</span>

      <div class="carousel">
        <span class="prev" onclick="changeSlide(-1)" style="cursor:pointer;font-size:40px;color:white;margin-right:10px;">&#10094;</span>

        <div class="popup-content-wrapper" style="display:flex;justify-content:center;align-items:center">
          <div style="aspect-ratio:4 / 3;width:auto;overflow:hidden;display:flex;justify-content:center;align-items:center;">
            <img class="popup-content" id="popupImage" style="width:100%;height:auto" />
          </div>
          <div class="popup-text" id="popupText" style="color:black;text-align:center;margin-top:10px"></div>
        </div>

        <span class="next" onclick="changeSlide(1)" style="cursor:pointer;font-size:40px;color:white;margin-left:10px;">&#10095;</span>
      </div>
    </div>

    <!-- (í•„ìˆ˜) íŒì—… ë™ì‘ í•¨ìˆ˜ë“¤ í¬í•¨ëœ íŒŒì¼ -->
    <script src="./js/event.js"></script>
    <script>
      (function () {
        // event.jsì˜ expandImageë¥¼ ê°ì‹¸ì„œ data-largeë¥¼ /file2/ë¡œ ë³´ì •
        const prev = window.expandImage;
        window.expandImage = function (el) {
          try {
            const imgEl = el.querySelector('img');
            const large0 = imgEl?.getAttribute('data-large') || '';
            if (large0) {
              const large2 = (typeof toFile2 === 'function') ? toFile2(large0) : encodeURI(large0);
              imgEl.setAttribute('data-large', large2);
            }
          } catch (e) { /* no-op */ }
          return prev ? prev(el) : null;
        };
      })();
    </script>

    <!-- Footer -->
    <section class="footer">
      <app-footer _ngcontent-xno-c271="" _nghost-xno-c31="">
        <footer _ngcontent-xno-c31="">
          <div _ngcontent-xno-c31="" class="wrap-footer-info">
            <div _ngcontent-xno-c31="" class="con-info">
              <img
                _ngcontent-xno-c31=""
                src="./images/kseaicon/ksealogo_white.png"
                alt="KSEA_logo"
              />
              <ul _ngcontent-xno-c31="">
                <li _ngcontent-xno-c31="" id="ngcontent1">
                  Korean-American Scientists and Engineers Association (KSEA)
                </li>
                <li _ngcontent-xno-c31="" id="ngcontent2">
                  KSEA Young Generation Group | University of California, Davis
                </li>
                <li _ngcontent-xno-c31="">
                  <span style="color: rgb(223, 223, 223)"
                    >Email: ucdksea@gmail.com</span
                  >
                </li>
                <li _ngcontent-xno-c31="">
                  <span style="color: rgb(223, 223, 223)"
                    >Copyright Â© 2024 KSEA Sacramento chapter, All Rights
                    Reserved</span
                  >
                </li>
                <li>
                  <a href="/login"
                     rel="nofollow"
                     class="text-sm text-gray-400 hover:text-white hover:underline transition"
                     aria-label="Officer login (KSEA UC Davis officers only)">
                    Officer Login
                  </a>              
                </li>
              </ul>
            </div>
            <div><p><span style = "color: #3954A6 ;line-height: 0;">by ë°±ì§€ì›&ë°•ì—¬ì§„</span></p></div>
            <div _ngcontent-xno-c31="" class="con-sns">
              <ul _ngcontent-xno-c31="">
                <li _ngcontent-xno-c31="">
                  <a
                    _ngcontent-xno-c31=""
                    href="https://www.instagram.com/kseadavis/"
                    target="_blank"
                    ><img
                      _ngcontent-xno-c31=""
                      src="./images/instagram.png"
                      width="50"
                      height="50"
                      alt="KSEA instagram"
                  /></a>
                </li>
                <li _ngcontent-xno-c31="">
                  <a
                    _ngcontent-xno-c31=""
                    href="https://linktr.ee/ucdksea"
                    target="_blank"
                    ><img
                      _ngcontent-xno-c31=""
                      src="./images/linktree.png"
                      width="50"
                      height="50"
                      alt="Ksea linktree"
                  /></a>
                </li>
              </ul>
            </div>
          </div>
        </footer>
      </app-footer>
    </section>

    <!-- ëª¨ë°”ì¼ ë©”ë‰´ í† ê¸€ -->
    <script>
      const navLinks = document.getElementById("navLinks");
      const menuIcon = document.getElementById("menuIcon");
      const closeIcon = document.getElementById("closeIcon");

      function openMenu() {
        navLinks.style.right = "0";
        menuIcon.style.display = "none";
        closeIcon.style.display = "block";
      }

      function closeMenu() {
        navLinks.style.right = "-200px";
        menuIcon.style.display = "block";
        closeIcon.style.display = "none";
      }
    </script>

    <!-- ë°±ì—”ë“œ ì—°ë™ ìŠ¤í¬ë¦½íŠ¸ (ë°ì´í„° ì—†ìœ¼ë©´ ì•ˆ ë³´ì´ê²Œ/ì¡°ìš©íˆ ì‹¤íŒ¨) -->
    <script>
      // ë¡œì»¬ ê°œë°œ í™˜ê²½ ê°ì§€ ê°•í™”: localhost, 127.0.0.1, 0.0.0.0, 192.168.x.x, í¬íŠ¸ 5500
      const isLocalHost =
        /^(localhost|127\.0\.0\.1|0\.0\.0\.0)$/.test(location.hostname) ||
        /^192\.168\./.test(location.hostname) ||
        location.port === "5500";
    
      const DEV = isLocalHost;
      const API_BASE = "https://api.ucdksea.com";  // ì ˆëŒ€ê²½ë¡œ!
      const API = API_BASE;  
      fetch(`${API_BASE}/api/ping`, { credentials: "include" });
          </script>
          <!-- <script>
            // ì ˆëŒ€ URL + ì•ˆì „ ì¸ì½”ë”©
            function absUrl(u){
              if(!u) return "";
              try{
                const base = (typeof API !== "undefined" && API) ? API : location.origin;
                const url  = u.startsWith("http") ? u : new URL(u, base).toString();
                return encodeURI(url);
              }catch{
                return encodeURI(u);
              }
            }
            
            // ... wrap.innerHTML = html; ë°”ë¡œ ì•„ë˜ì— ë¶™ì´ê¸°
            wrap.querySelectorAll('.polaroid img').forEach(img => {
              const cands = [
                img.getAttribute('data-thumb-original'),
                img.getAttribute('data-large'),
                img.getAttribute('data-poster')
              ].filter(Boolean);
            
              let i = 0;
              function loadNext(){
                if (i >= cands.length) { img.removeAttribute('src'); img.alt = '(image missing)'; return; }
                img.src = absUrl(cands[i++]);
              }
              img.onerror = loadNext;
              loadNext();
            });
            </script> -->
            
          
    

    <!-- 1) Event Polaroid (Gallery) -->
    <script>
      (async () => {
        const wrap = document.getElementById("polaroidGrid");
        if (!wrap) return;
      
        // ì•ˆì „ ì´ìŠ¤ì¼€ì´í”„
        const esc = (s) => (s || "").toString().replace(/"/g, "&quot;");
      
        // /file2 ë³´ì •: ìš°ë¦¬ API í˜¸ìŠ¤íŠ¸ì¼ ë•Œë§Œ êµì²´ (ì™¸ë¶€ í˜¸ìŠ¤íŠ¸ëŠ” ê·¸ëŒ€ë¡œ)
        function toFile2Safe(u) {
          if (!u) return "";
          try {
            const base = (typeof API !== "undefined" && API) ? API : location.origin;
            // ì ˆëŒ€/ìƒëŒ€ ëª¨ë‘ í—ˆìš© + ê³µë°± ë“± ì¸ì½”ë”©
            const url = u.startsWith("http") ? new URL(encodeURI(u)) : new URL(encodeURI(u), base);
            const apiHost = new URL(base).host;
            // ê°™ì€ í˜¸ìŠ¤íŠ¸(+ê²½ë¡œê¸°ë°˜)ì¼ ë•Œë§Œ /file2 ë¦¬ë¼ì´íŠ¸
            if (url.host === apiHost) {
              let p = url.pathname;
              if (p.includes("/file2/")) return url.toString();
              if (p.includes("/file/")) { url.pathname = p.replace("/file/", "/file2/"); return url.toString(); }
              if (p.startsWith("/uploads/")) { url.pathname = "/file2" + p; return url.toString(); }
              if (p.includes("/uploads/")) { url.pathname = p.replace("/uploads/", "/file2/uploads/"); return url.toString(); }
            }
            return url.toString();
          } catch {
            // ì‹¤íŒ¨ ì‹œì—ë„ ìµœì†Œí•œ ì¸ì½”ë”©ë§Œ ì ìš©
            return encodeURI(u);
          }
        }
      
        try {
          const r = await fetch(`${API}/api/admin/posts?type=EVENT_POLAROID&active=1`, { credentials: "omit" });
          if (!r.ok) throw new Error(r.status);
          const { posts = [] } = await r.json();
          if (!posts.length) { wrap.innerHTML = ""; return; }
      
          const html = posts.map((p) => {
            const m = p.meta || {};
      
            // ğŸ”‘ ì¸ë„¤ì¼/íŒì—… ì†ŒìŠ¤ ì„ ì •: ì¼ë°˜ ì´ë¯¸ì§€ ìš°ì„  â†’ í¬ìŠ¤í„° â†’ ë°°ì—´
            const pickImage = () =>
              (p.imageUrl || m.imageUrl || p.posterUrl || m.posterUrl ||
               (Array.isArray(p.images) && p.images[0]) ||
               (Array.isArray(m.images) && m.images[0]) || "");
      
            const src = pickImage();                 // ëª©ë¡/íŒì—… ë™ì¼ ì†ŒìŠ¤ ì‚¬ìš© (ë¶ˆì¼ì¹˜ ë°©ì§€)
            const title   = (p.title || "").trim();
            const quarter = (p.quarter || m.quarter || p.semester || m.semester || "").trim();
            const year    = (p.year || m.year || "").trim();
            const captionRaw = (quarter && year) ? `${quarter} ${year}` : title;
            const dateStr    = p.date ? new Date(p.date).toISOString().slice(0,10) : "";
            const bottomCaption = [captionRaw, title].filter(Boolean).join(" ");
      
            const primaryLink =
              (p.instagramUrl || p.formUrl || p.linkUrl || m.instagramUrl || m.formUrl || "").trim();
      
            // íŒì—…ìš© ì„¤ëª…
            const line1 = `${esc(title)}$<span style='color:gray;'>${esc(captionRaw)}${dateStr ? " | " + dateStr : ""}</span>$<span style='color:#ececec;'>_____________________</span>$`;
            const line2 = p.descKo ? `<br>${esc(p.descKo)}$` : "";
            const line3 = p.descEn ? `<br>${esc(p.descEn)}<br>$` : "";
            const dataTextEnc = encodeURIComponent([line1, line2, line3, "<img-poster/>"].join(""));
      
            return `
              <div class="event-item">
                <div class="polaroid" onclick="expandImage(this)">
                  <img
                    alt="${esc(title)}"
                    data-src-original="${esc(src)}"
                    data-large="${esc(src)}"
                    data-text-enc="${esc(dataTextEnc)}"
                    data-link="${esc(primaryLink)}"
                  />
                  <p>${esc(bottomCaption)}</p>
                  ${primaryLink ? `<div style="margin-top:6px;">
                    <a href="${esc(primaryLink)}" target="_blank" rel="noopener" class="text-sm underline"></a>
                  </div>` : ""}
                </div>
              </div>
            `;
          }).join("");
      
          wrap.innerHTML = html;
      
          // ì‹¤ì œ ë¡œë”©: /file2 ë³´ì • â†’ ì‹¤íŒ¨ì‹œ ì›ë³¸ ì¬ì‹œë„
          wrap.querySelectorAll('.polaroid img').forEach(img => {
            const original = img.getAttribute('data-src-original') || "";
            if (!original) return;
      
            const src1 = toFile2Safe(original);
            const src2 = encodeURI(original); // í´ë°±(ì›ë³¸)
      
            img.setAttribute("data-original", src2);
            img.src = src1;
      
            // íŒì—…ìš©ë„ ë™ì¼í•˜ê²Œ ë³´ì •
            const large0 = img.getAttribute('data-large') || "";
            if (large0) img.setAttribute('data-large', toFile2Safe(large0));
      
            img.onerror = function () {
              if (img.getAttribute("data-tried-original") === "1") return;
              img.setAttribute("data-tried-original", "1");
              img.src = img.getAttribute("data-original");
            };
          });
      
        } catch (e) {
          console.warn("EVENT_POLAROID fetch failed:", e);
          wrap.innerHTML = "";
        }
      })();
      </script>
      
      
    
    
    
    

<!-- 2) Upcoming Event (ìˆì„ ë•Œë§Œ í‘œì‹œ) -->
<script>
  (async () => {
    const section = document.getElementById("upcomingSection");
    const box = document.getElementById("upcomingBox");
    const a = box ? box.querySelector("a") : null;
    const img = document.getElementById("upcomingImg");
    const descEl = document.querySelector(".upcomingDesc");
    if (!section || !box || !a || !img || !descEl) return;

    try {
      const r = await fetch(`${API}/api/admin/posts?type=EVENT_UPCOMING&active=1`, { credentials: "omit" });
      if (!r.ok) throw new Error(r.status);
      const { posts = [] } = await r.json();

      if (!posts.length) {
        section.style.display = "none";
        return;
      }

      const p = posts[0];                          // â† ì—¬ê¸°ì„œ pë¥¼ í™•ë³´
      section.style.display = "";                  // ì„¹ì…˜ í‘œì‹œ

      // ë§í¬: formUrl â†’ instagramUrl â†’ linkUrl â†’ '#'
      const href = p.meta?.formUrl || p.meta?.instagramUrl || p.linkUrl || "#";
      a.href = href;
      if (href === "#") a.addEventListener("click", (e) => e.preventDefault());

      // ì´ë¯¸ì§€: poster(ìš°ì„ ) â†’ imageUrl, ê·¸ë¦¬ê³  /file2 ê°•ì œ
      const original = p.meta?.posterUrl || p.imageUrl || "";
      setImgWithFallback(img, original);

      // ì„¤ëª…: ko ìš°ì„  â†’ en
      descEl.innerHTML = p.descKo || p.descEn || "";

    } catch (e) {
      console.warn("EVENT_UPCOMING fetch failed:", e);
      section.style.display = "none";
    }
  })();
</script>
<script>
  // file2 ê²½ë¡œ ì¶”ì •
  function toFile2(url) {
    if (!url) return "";
    try {
      const base = (typeof API !== "undefined" && API) ? API : location.origin;
      const u = url.startsWith("http") ? new URL(url) : new URL(url, base);
      let p = u.pathname;
      if (p.includes("/file2/")) return u.toString();
      if (p.includes("/file/")) { u.pathname = p.replace("/file/", "/file2/"); return u.toString(); }
      if (p.startsWith("/uploads/")) { u.pathname = "/file2" + p; return u.toString(); }
      if (p.includes("/uploads/")) { u.pathname = p.replace("/uploads/", "/file2/uploads/"); return u.toString(); }
      return u.toString();
    } catch {
      if (url.includes("/file/")) return url.replace("/file/", "/file2/");
      if (url.includes("/uploads/")) return url.replace("/uploads/", "/file2/uploads/");
      return url;
    }
  }

  // <img>ì— file2 ìš°ì„  ì ìš© + ì‹¤íŒ¨ ì‹œ ì›ë³¸ìœ¼ë¡œ ìë™ ëŒ€ì²´
  function setImgWithFallback(imgEl, srcOriginal) {
    const srcFile2 = toFile2(srcOriginal);
    imgEl.setAttribute("data-original", srcOriginal);
    imgEl.src = srcFile2;
    imgEl.onerror = function () {
      if (imgEl.getAttribute("data-tried-original") === "1") return;
      imgEl.setAttribute("data-tried-original", "1");
      imgEl.src = imgEl.getAttribute("data-original");
    };
  }
</script>


  </body>
</html>
